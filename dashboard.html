<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel • Arte Com Carinho</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/heroicons@latest/css/heroicons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body class="bg-pink-100 min-h-screen antialiased">
  <header class="bg-pink-600 shadow-lg p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-white">
      <i class="fas fa-palette mr-2"></i>Arte Com Carinho
    </h1>
     <a href="admin.html" target="_blank" class="flex items-center text-sm text-pink-600 bg-white px-4 py-2 rounded-lg hover:text-black-700 font-medium transition-colors shadow hover:shadow-md">Painel Administração Site</a>
    <button onclick="logout()" class="flex items-center text-sm text-pink-600 bg-white px-4 py-2 rounded-lg hover:bg-pink-50 transition-colors shadow hover:shadow-md">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
      </svg>
      Sair
    </button>
  </header>

  <main class="p-6 space-y-8">
    <div>
      <h2 id="saudacaoUsuario" class="text-2xl font-semibold text-pink-700 mb-1">Olá!</h2>
      <p class="text-md text-gray-600">Bem-vindo(a) de volta ao seu painel.</p>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-lg border border-pink-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Total de Produtos</p>
            <p id="total-produtos" class="text-3xl font-bold text-pink-600">0</p>
          </div>
          <div class="bg-pink-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-pink-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10.5 11.25h3M12 17.25v-6.75" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Produtos cadastrados no sistema.</p>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg border border-orange-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Itens com Baixo Estoque</p>
            <p id="baixo-estoque" class="text-3xl font-bold text-orange-500">0</p>
          </div>
           <div class="bg-orange-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-orange-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Produtos precisando de reposição (ex: < 5 unidades).</p>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-lg border border-teal-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Valor Estimado do Estoque</p>
            <p id="valor-estoque" class="text-3xl font-bold text-teal-600">R$ 0,00</p>
          </div>
          <div class="bg-teal-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-teal-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 2.25 4.5h.75A.75.75 0 0 1 3.75 5.25v.75Zm0 0h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375V7.5h.375Zm0 2.25a.75.75 0 0 0-.75.75v.75c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75v-.75a.75.75 0 0 0-.75-.75h-.75Zm0 2.25h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375v-.75h.375Zm0 0c.199 0 .375-.024.528-.055a21.297 21.297 0 0 0 1.621-.302c.397-.099.71-.342.71-.737V4.5a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v11.25c0 .414.336.75.75.75h.75Zm12.75-2.25h.008v.008H16.5V15Z" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Soma do (preço x quantidade) de todos os itens.</p>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="chart-container h-80 md:h-96"> <h3 class="text-lg font-semibold text-pink-700 mb-3 text-center">Vendas nos Últimos 7 Dias</h3>
        <canvas id="graficoVendasSemana"></canvas>
      </div>
      <div class="chart-container h-80 md:h-96"> <h3 class="text-lg font-semibold text-pink-700 mb-3 text-center">Status dos Pedidos</h3>
        <canvas id="graficoStatusPedidos"></canvas>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-pink-200 transition-shadow border border-pink-200">
        <h3 class="text-xl font-semibold text-pink-700 mb-3">Gerenciar Empresa</h3>
        <div class="space-y-3">
          <a href="produtos.html" class="flex items-center space-x-3 p-4 bg-pink-50 hover:bg-pink-100 rounded-lg transition-colors text-pink-700 hover:text-pink-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10.5 11.25h3M12 17.25v-6.75" />
            </svg>
            <div>
              <span class="font-medium">Estoque de Produtos</span>
              <p class="text-xs text-gray-500">Cadastrar, visualizar e gerenciar produtos</p>
            </div>
          </a>
          <a href="vendas.html" class="flex items-center space-x-3 p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors text-purple-700 hover:text-purple-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 2.25 4.5h.75A.75.75 0 0 1 3.75 5.25v.75Zm0 0h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375V7.5h.375Zm0 2.25a.75.75 0 0 0-.75.75v.75c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75v-.75a.75.75 0 0 0-.75-.75h-.75Zm0 2.25h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375v-.75h.375Zm0 0c.199 0 .375-.024.528-.055a21.297 21.297 0 0 0 1.621-.302c.397-.099.71-.342.71-.737V4.5a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v11.25c0 .414.336.75.75.75h.75Zm12.75-2.25h.008v.008H16.5V15Z" />
            </svg>
            <div>
              <span class="font-medium">Registro de Vendas</span>
              <p class="text-xs text-gray-500">Lançar novas vendas e ver histórico</p>
            </div>
          </a>
          <a href="pedidos.html" class="flex items-center space-x-3 p-4 bg-sky-50 hover:bg-sky-100 rounded-lg transition-colors text-sky-700 hover:text-sky-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
            </svg>
            <div>
              <span class="font-medium">Gerenciar Pedidos</span>
              <p class="text-xs text-gray-500">Acompanhar e atualizar pedidos de clientes</p>
            </div>
          </a>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-pink-200 transition-shadow border border-pink-200">
        <h3 class="text-xl font-semibold text-pink-700 mb-3">Alertas e Atividades</h3>
        <div id="lista-atividades" class="space-y-3 max-h-60 overflow-y-auto custom-scroll pr-2">
           </div>
        <p id="sem-atividades" class="text-sm text-gray-400 text-center hidden">Nenhuma atividade recente.</p>
      </div>
    </section>

  </main>
  <footer class="text-center py-6 mt-12 border-t border-pink-200">
    <p class="text-sm text-pink-700">
      Sistema desenvolvido por <a href="https://github.com/chsouza1" target="_blank" class="text-pink-600 hover:underline">Carlos Henrique</a> • Arte Com Carinho
    </p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://zjjvzouaalphxenypomp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqanZ6b3VhYWxwaHhlbnlwb21wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NDU0MzMsImV4cCI6MjA2MTEyMTQzM30.V846ghEfXW7D1DegBovnzW7i8T27gdzmygWXOiS7SxQ';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let graficoVendasSemanaInstance = null; 
    let graficoStatusPedidosInstance = null; 

    
    function formatarDataGrafico(dataISO) {
        const data = new Date(dataISO + 'T00:00:00'); 
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        return `${dia}/${mes}`;
    }

async function renderizarGraficoVendasSemana() { 
    console.log("Tentando renderizar gráfico de vendas ESTÁTICO...");
    const canvasElement = document.getElementById('graficoVendasSemana');
    if (!canvasElement) {
        console.error("Elemento canvas 'graficoVendasSemana' não encontrado!");
        return;
    }
    const ctx = canvasElement.getContext('2d');

    const dadosEstaticos = {
        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
        datasets: [{
            label: 'Vendas Teste',
            data: [1, 19, 3, 5, 2, 3, 7], 
            backgroundColor: 'rgba(236, 72, 153, 0.5)', 
            borderColor: 'rgba(236, 72, 153, 1)', 
            borderWidth: 1
        }]
    };

    if (graficoVendasSemanaInstance) { 
        graficoVendasSemanaInstance.destroy();
    }
    graficoVendasSemanaInstance = new Chart(ctx, {
        type: 'bar',
        data: dadosEstaticos,
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                 legend: { display: true } 
            }
        }
    });
    console.log("Gráfico de vendas ESTÁTICO deveria estar renderizado.");
}

    // Função para renderizar gráfico de status dos pedidos
    async function renderizarGraficoStatusPedidos() {
        const { data: pedidos, error: erroPedidos } = await supabase
            .from('pedidos')
            .select('status_pedido');

        if (erroPedidos) {
            console.error("Erro ao buscar status dos pedidos:", erroPedidos.message);
            return;
        }

        const contagemStatus = {};
        if (pedidos) {
            pedidos.forEach(pedido => {
                contagemStatus[pedido.status_pedido] = (contagemStatus[pedido.status_pedido] || 0) + 1;
            });
        }

        const labelsStatus = Object.keys(contagemStatus);
        const dataStatus = Object.values(contagemStatus);
        
      
        const backgroundColors = [
            'rgba(236, 72, 153, 0.7)',  // Pink
            'rgba(219, 39, 119, 0.7)',  // Pink mais forte
            'rgba(190, 24, 93, 0.7)',   // Pink escuro
            'rgba(251, 113, 133, 0.7)', // Rose
            'rgba(249, 168, 212, 0.7)', // Light Pink
            'rgba(131, 24, 67, 0.7)',   // Darker Rose
            'rgba(59, 130, 246, 0.7)',  // Blue
            'rgba(16, 185, 129, 0.7)',  // Green
            'rgba(245, 158, 11, 0.7)',  // Amber
            'rgba(107, 114, 128, 0.7)'  // Gray
        ];
        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));


        const ctx = document.getElementById('graficoStatusPedidos').getContext('2d');
        if (graficoStatusPedidosInstance) {
            graficoStatusPedidosInstance.destroy();
        }
        graficoStatusPedidosInstance = new Chart(ctx, {
            type: 'doughnut', // ou 'pie' tanto faz
            data: {
                labels: labelsStatus,
                datasets: [{
                    label: 'Contagem de Pedidos',
                    data: dataStatus,
                    backgroundColor: backgroundColors.slice(0, labelsStatus.length),
                    borderColor: borderColors.slice(0, labelsStatus.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom', // Posição da legenda
                    },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }


    // Função para buscar dados do painel (modificada para incluir gráficos)
    async function carregarDadosPainel() {
      console.log("carregarDadosPainel FOI CHAMADA às:", new Date().toLocaleTimeString());
      if (!currentUser) return;

      const saudacaoEl = document.getElementById('saudacaoUsuario');
      if (saudacaoEl && currentUser.email) {
        saudacaoEl.textContent = `Olá, ${currentUser.email.split('@')[0]}!`;
      }
      
      // 1. Total de Produtos
      const { count: totalProdutos, error: produtosError } = await supabase
        .from('produtos')
        .select('*', { count: 'exact', head: true }); 

      if (totalProdutos !== null) {
        document.getElementById('total-produtos').textContent = totalProdutos;
      } else if (produtosError) {
        console.error("Erro ao buscar total de produtos:", produtosError.message);
      }
 
      // 2. Itens com Baixo Estoque
      const LIMITE_BAIXO_ESTOQUE = 5;
      const { data: baixoEstoqueItens, error: baixoEstoqueError, count: totalBaixoEstoque } = await supabase
        .from('produtos')
        .select('nome, quantidade', { count: 'exact' }) 
        .lt('quantidade', LIMITE_BAIXO_ESTOQUE);

      const listaAtividadesEl = document.getElementById('lista-atividades');
      const semAtividadesEl = document.getElementById('sem-atividades');
      listaAtividadesEl.innerHTML = ''; // Limpa atividades anteriores
      let temAtividades = false;

      if (totalBaixoEstoque !== null) {
        document.getElementById('baixo-estoque').textContent = totalBaixoEstoque;
        if (baixoEstoqueItens && baixoEstoqueItens.length > 0) {
            temAtividades = true;
            baixoEstoqueItens.forEach(item => {
                const alertaDiv = document.createElement('div');
                alertaDiv.className = 'flex items-start space-x-3 p-3 bg-red-50 rounded-lg';
                alertaDiv.innerHTML = `
                    <div class="bg-red-100 p-2 rounded-full mt-1 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-red-700">Baixo estoque: "${item.nome}" com apenas ${item.quantidade} unidade(s)!</p>
                        <p class="text-xs text-gray-500">Considere repor o estoque.</p>
                    </div>
                `;
                listaAtividadesEl.appendChild(alertaDiv);
            });
        }
      } else if (baixoEstoqueError) {
          console.error("Erro ao buscar itens com baixo estoque:", baixoEstoqueError.message);
      }

      // 3. Valor Estimado do Estoque
      const { data: todosProdutos, error: todosProdutosError } = await supabase
        .from('produtos')
        .select('preco, quantidade');

      if (todosProdutos) {
        const valorTotal = todosProdutos.reduce((acc, produto) => {
          return acc + (parseFloat(produto.preco || 0) * parseInt(produto.quantidade || 0));
        }, 0);
        document.getElementById('valor-estoque').textContent = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      } else if (todosProdutosError) {
         console.error("Erro ao buscar produtos para calcular valor:", todosProdutosError.message);
      }

      // Gerenciar mensagem "Sem atividades"
      if (temAtividades) {
        if(semAtividadesEl) semAtividadesEl.classList.add('hidden');
      } else {
        if(listaAtividadesEl && semAtividadesEl) {
            if (listaAtividadesEl.children.length === 0) {
                semAtividadesEl.classList.remove('hidden');
            } else {
                semAtividadesEl.classList.add('hidden');
            }
        }
      }

      // Chamar funções para renderizar os gráficos
       await renderizarGraficoVendasSemana();
       await renderizarGraficoStatusPedidos();
    }

    // Verifica se o usuário está logado e carrega dados
    async function initDashboard() {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) {
        console.error("Erro ao obter sessão:", sessionError.message);
        window.location.href = 'index.html'; 
        return;
      }
      if (!session) {
        window.location.href = 'index.html';
      } else {
        currentUser = session.user;
        await carregarDadosPainel();
      }
    }

    // Logout
    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error("Erro ao fazer logout:", error.message);
      }
      window.location.href = 'index.html';
    }

    window.logout = logout; 
    initDashboard(); 
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</body>
</html>