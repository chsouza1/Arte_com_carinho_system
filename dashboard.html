<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel • Arte Com Carinho</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/heroicons@latest/css/heroicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body class="bg-pink-100 min-h-screen antialiased">
  <header class="bg-pink-600 shadow-lg p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-white">
      <i class="fas fa-palette mr-2"></i>Arte Com Carinho
    </h1>
    <button onclick="logout()" class="flex items-center text-sm text-pink-600 bg-white px-4 py-2 rounded-lg hover:bg-pink-50 transition-colors shadow hover:shadow-md">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
      </svg>
      Sair
    </button>
  </header>

  <main class="p-6 space-y-8">
    <div>
      <h2 class="text-2xl font-semibold text-pink-700 mb-1">Olá, [Nome do Usuário]!</h2>
      <p class="text-md text-gray-600">Bem-vindo(a) de volta ao seu painel.</p>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-lg border border-pink-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Total de Produtos</p>
            <p id="total-produtos" class="text-3xl font-bold text-pink-600">0</p>
          </div>
          <div class="bg-pink-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-pink-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10.5 11.25h3M12 17.25v-6.75" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Produtos cadastrados no sistema.</p>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg border border-orange-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Itens com Baixo Estoque</p>
            <p id="baixo-estoque" class="text-3xl font-bold text-orange-500">0</p>
          </div>
           <div class="bg-orange-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-orange-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Produtos precisando de reposição (ex: < 5 unidades).</p>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-lg border border-teal-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase">Valor Estimado do Estoque</p>
            <p id="valor-estoque" class="text-3xl font-bold text-teal-600">R$ 0,00</p>
          </div>
          <div class="bg-teal-100 p-3 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-teal-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 2.25 4.5h.75A.75.75 0 0 1 3.75 5.25v.75Zm0 0h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375V7.5h.375Zm0 2.25a.75.75 0 0 0-.75.75v.75c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75v-.75a.75.75 0 0 0-.75-.75h-.75Zm0 2.25h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375v-.75h.375Zm0 0c.199 0 .375-.024.528-.055a21.297 21.297 0 0 0 1.621-.302c.397-.099.71-.342.71-.737V4.5a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v11.25c0 .414.336.75.75.75h.75Zm12.75-2.25h.008v.008H16.5V15Z" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Soma do (preço x quantidade) de todos os itens.</p>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-pink-200 transition-shadow border border-pink-200">
        <h3 class="text-xl font-semibold text-pink-700 mb-3">Gerenciar Empresa</h3>
        <div class="space-y-3">
          <a href="produtos.html" class="flex items-center space-x-3 p-4 bg-pink-50 hover:bg-pink-100 rounded-lg transition-colors text-pink-700 hover:text-pink-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10.5 11.25h3M12 17.25v-6.75" />
            </svg>
            <div>
              <span class="font-medium">Estoque de Produtos</span>
              <p class="text-xs text-gray-500">Cadastrar, visualizar e gerenciar produtos</p>
            </div>
          </a>
          <a href="vendas.html" class="flex items-center space-x-3 p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors text-green-700 hover:text-green-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 2.25 4.5h.75A.75.75 0 0 1 3.75 5.25v.75Zm0 0h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375V7.5h.375Zm0 2.25a.75.75 0 0 0-.75.75v.75c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75v-.75a.75.75 0 0 0-.75-.75h-.75Zm0 2.25h.008v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 2.25.008.007H3.375v-.75h.375Zm0 0c.199 0 .375-.024.528-.055a21.297 21.297 0 0 0 1.621-.302c.397-.099.71-.342.71-.737V4.5a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v11.25c0 .414.336.75.75.75h.75Zm12.75-2.25h.008v.008H16.5V15Z" />
            </svg>
            <div>
              <span class="font-medium">Registro de Vendas</span>
              <p class="text-xs text-gray-500">Lançar novas vendas e ver histórico</p>
            </div>
          </a>
          <a href="pedidos.html" class="flex items-center space-x-3 p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors text-green-700 hover:text-green-800">
            <div style="width: 30px; height: auto;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 394.688">
                <path fill="#FB5541" fill-rule="nonzero" d="M133.644 228.234L91.993 77.405a14.395 14.395 0 01-.878-4.967c0-7.964 6.458-14.422 14.422-14.422h204.83c-11.002 18.116-17.336 39.38-17.336 62.121 0 30.672 11.704 61.347 35.11 84.753 19.126 19.126 43.112 30.437 67.98 33.935h-248.62v-.043c-6.307.003-12.096-4.175-13.857-10.548z"/>
                <path fill="#333" d="M352.424 324.199c19.464 0 35.244 15.779 35.244 35.245 0 19.464-15.78 35.244-35.244 35.244-19.466 0-35.245-15.78-35.245-35.244 0-19.466 15.779-35.245 35.245-35.245zm-154.518 0c19.464 0 35.244 15.779 35.244 35.245 0 19.464-15.78 35.244-35.244 35.244-19.466 0-35.245-15.78-35.245-35.244 0-19.466 15.779-35.245 35.245-35.245z"/>
                <path fill="#B73E30" fill-rule="nonzero" d="M189.2 122.517c-.372-5.575 3.846-10.397 9.422-10.769 5.575-.371 10.397 3.847 10.768 9.423l3.625 53.87c.372 5.576-3.846 10.397-9.422 10.769-5.575.371-10.397-3.847-10.769-9.422l-3.624-53.871zm66.294-.673c0-5.598 4.539-10.137 10.137-10.137 5.597 0 10.136 4.539 10.136 10.137v53.87c0 5.598-4.539 10.137-10.136 10.137-5.598 0-10.137-4.539-10.137-10.137v-53.87z"/>
                <path fill="#484848" fill-rule="nonzero" d="M14.419 28.838C6.457 28.838 0 22.381 0 14.419 0 6.457 6.457 0 14.419 0h37.525l1.44.072C66.493.311 78.423 2.88 88.457 9.125c10.982 6.833 19.18 17.493 23.507 33.407 14.579 62.52 34.659 125.138 49.666 187.674 6.259 24.738 11.416 37.474 19.525 42.922 7.077 4.754 18.794 5.766 37.235 5.701 7.5-.023 14.812-.177 22.309-.177h154.328c7.962 0 14.419 6.457 14.419 14.419 0 7.962-6.457 14.419-14.419 14.419H240.022c-7.128 0-14.122.051-21.246.065-24.323.065-40.425-1.683-53.62-10.547-15.288-10.268-23.342-27.714-31.448-59.821l-49.57-187.11c-2.241-8.246-6.016-13.475-10.887-16.505-5.222-3.249-12.178-4.617-20.226-4.775l-1.081.041H14.419z"/>
                <path fill="#333" fill-rule="nonzero" d="M0 14.419C0 6.457 6.457 0 14.419 0h37.525l1.44.072C66.493.311 78.423 2.88 88.457 9.125c10.982 6.833 19.18 17.493 23.507 33.407 14.579 62.52 34.659 125.138 49.666 187.674 6.259 24.738 11.416 37.474 19.525 42.922 7.087 4.761 18.828 5.77 37.317 5.701 7.463-.023 14.74-.177 22.2-.177h154.355c7.962 0 14.419 6.457 14.419 14.419H229.231c-55.159.971-67.194-2.524-81.555-59.376L98.05 46.305c-6.57-24.167-23.913-31.756-46.106-31.886H0z"/>
                <path fill="#333" d="M342.817 50.059c38.702-38.703 101.452-38.703 140.155 0 38.704 38.703 38.704 101.453 0 140.156-38.703 38.703-101.453 38.703-140.155 0-38.704-38.703-38.704-101.453 0-140.156z"/>
                <path fill="#fff" d="M366.922 104.016h29.851V74.164a4.644 4.644 0 014.634-4.633h22.975c2.55 0 4.634 2.124 4.634 4.633v29.852h29.85c2.547 0 4.633 2.108 4.633 4.633v22.975c0 2.525-2.107 4.634-4.633 4.634h-29.85v29.85c0 2.53-2.104 4.633-4.634 4.633h-22.975c-2.53 0-4.634-2.083-4.634-4.633v-29.85h-29.851c-2.529 0-4.634-2.083-4.634-4.634v-22.975c0-2.549 2.088-4.633 4.634-4.633z"/>
              </svg>
            </div>
            <div>
              <span class="font-medium">Registro de novos pedidos</span>
              <p class="text-xs text-gray-500">Lançar novos pedidos dos clientes</p>
            </div>
          </a>

          </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-pink-200 transition-shadow border border-pink-200">
        <h3 class="text-xl font-semibold text-pink-700 mb-3">Alertas e Atividades</h3>
        <div id="lista-atividades" class="space-y-3 max-h-60 overflow-y-auto custom-scroll pr-2">
        </div>
          </div>
          </div>
          <p id="sem-atividades" class="text-sm text-gray-400 text-center hidden">Nenhuma atividade recente.</p>
        </div>
      </div>
    </section>

  </main>
  <footer class="text-center py-6 mt-12 border-t border-pink-200">
    <p class="text-sm text-pink-700">
      Sistema desenvolvido por <a href="https://github.com/chsouza1" class="text-pink-600 hover:underline">Carlos Henrique</a> • Arte Com Carinho
    </p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://zjjvzouaalphxenypomp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqanZ6b3VhYWxwaHhlbnlwb21wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NDU0MzMsImV4cCI6MjA2MTEyMTQzM30.V846ghEfXW7D1DegBovnzW7i8T27gdzmygWXOiS7SxQ';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // Função para buscar dados do painel
    async function carregarDadosPainel() {
      if (!currentUser) return;

      // Atualiza o nome do usuário (Exemplo, idealmente viria do perfil)
      const userNameEl = document.querySelector('main div h2');
      if (userNameEl && currentUser.email) {
        userNameEl.textContent = `Olá, ${currentUser.email.split('@')[0]}!`;
      }
      
      // 1. Total de Produtos
      const { data: produtos, error: produtosError, count: totalProdutos } = await supabase
        .from('produtos') // Certifique-se que sua tabela é 'produtos'
        .select('*', { count: 'exact', head: true }); // head:true para só pegar o count

      if (totalProdutos !== null) {
        document.getElementById('total-produtos').textContent = totalProdutos;
      } else if (produtosError) {
        console.error("Erro ao buscar total de produtos:", produtosError.message);
      }

  
      const LIMITE_BAIXO_ESTOQUE = 5;
      const { data: baixoEstoqueItens, error: baixoEstoqueError, count: totalBaixoEstoque } = await supabase
        .from('produtos')
        .select('nome, quantidade', { count: 'exact' }) // Adicione 'nome' e 'quantidade'
        .lt('quantidade', LIMITE_BAIXO_ESTOQUE); // 'lt' = less than (menor que)

      const listaAtividadesEl = document.getElementById('lista-atividades');
      const semAtividadesEl = document.getElementById('sem-atividades');
      let temAtividades = false;

      if (totalBaixoEstoque !== null) {
        document.getElementById('baixo-estoque').textContent = totalBaixoEstoque;
        // Adicionar alertas de baixo estoque na lista de atividades
        if (baixoEstoqueItens && baixoEstoqueItens.length > 0) {
            temAtividades = true;
            baixoEstoqueItens.forEach(item => {
                const alertaDiv = document.createElement('div');
                alertaDiv.className = 'flex items-start space-x-3 p-3 bg-red-50 rounded-lg';
                alertaDiv.innerHTML = `
                    <div class="bg-red-100 p-2 rounded-full mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-red-700">Baixo estoque: "${item.nome}" com apenas ${item.quantidade} unidade(s)!</p>
                        <p class="text-xs text-gray-500">Considere repor o estoque.</p>
                    </div>
                `;
                listaAtividadesEl.appendChild(alertaDiv);
            });
        }

      } else if (baixoEstoqueError) {
          console.error("Erro ao buscar itens com baixo estoque:", baixoEstoqueError.message);
      }


      // 3. Valor Estimado do Estoque
      const { data: todosProdutos, error: todosProdutosError } = await supabase
        .from('produtos')
        .select('preco, quantidade');

      if (todosProdutos) {
        const valorTotal = todosProdutos.reduce((acc, produto) => {
          return acc + (parseFloat(produto.preco) * parseInt(produto.quantidade));
        }, 0);
        document.getElementById('valor-estoque').textContent = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      } else if (todosProdutosError) {
         console.error("Erro ao buscar produtos para calcular valor:", todosProdutosError.message);
      }

      if (temAtividades) {
        semAtividadesEl.classList.add('hidden');
      } else {

        if (listaAtividadesEl.children.length === 0) {
            semAtividadesEl.classList.remove('hidden');
        } else {
            semAtividadesEl.classList.add('hidden');
        }
      }
    }

    // Verifica se o usuário está logado e carrega dados
    async function initDashboard() {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) {
        console.error("Erro ao obter sessão:", sessionError.message);
        window.location.href = 'index.html'; // Melhor redirecionar em caso de erro grave
        return;
      }
      if (!session) {
        window.location.href = 'index.html';
      } else {
        currentUser = session.user;
        await carregarDadosPainel();
      }
    }

    // Logout
    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error("Erro ao fazer logout:", error.message);
      }
      window.location.href = 'index.html';
    }

    window.logout = logout; // Torna a função logout acessível globalmente para o onclick
    
    initDashboard(); // Inicia o painel
  </script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>

</html>
